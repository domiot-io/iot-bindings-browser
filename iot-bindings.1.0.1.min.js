/*! Repository: https://github.com/domiot-io/iot-bindings-browser */
class AnotherMutex{constructor(){this._locked=!1,this._queue=[]}lock(){return new Promise(t=>{this._locked?this._queue.push(()=>{t(this._createUnlockFunction())}):(this._locked=!0,t(this._createUnlockFunction()))})}_createUnlockFunction(){let t=!1;return()=>{t||(t=!0,this._processQueue())}}_processQueue(){if(this._queue.length>0){const t=this._queue.shift();setTimeout(()=>t(),0)}else this._locked=!1}}class HTMLIoTIBitsButtonBindingElement extends HTMLElement{constructor(){super(),this._data="",this.elements=new Map,this.addEventListener("load",t=>{this._init()})}elementAttributeModified(t,e,i,n){}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){this._validateAttributes()&&(this.bdcom&&this.bdcom.subscribeRead(this),this.buffer="")}onData(t,e){if(t||!e||!e.data)return void console.error(`Error reading device file ${this.location} of binding ${this.nodeName} with id=${this.id} : `,t);const i=new Uint8Array(e.data),n=new TextDecoder("utf-8");this.buffer+=n.decode(i);let s=this.buffer.split(/\r\n|\r|\n/);this.buffer=s.pop(),s.forEach(t=>{this._onData.call(this,t)})}_onData(t){for(let e=0;e<t.length;e++){if(!this.elements||!this.elements.has(e))continue;const i=t[e],n=this._data[e];if(n&&n==i)continue;const s=this.elements.get(e);if(1==i){const t=new window.Event("press");s.dispatchEvent(t)}else{const t=new window.Event("release");s.dispatchEvent(t)}}this._data=t}}class HTMLIoTOBitsColorBindingElement extends HTMLElement{constructor(){super(),this._mtx=new AnotherMutex,this._data=[],this.elements=new Map,this._channelsPerElement=1,this._colorsChannel={},this._colorPropertyNames=["color"],this.addEventListener("load",t=>{this._init()})}_parseColorsChannel(){const t=this.getAttribute("colors-channel");if(!t)return void(this._colorsChannel.white=0);const e=t.split(";"),i=[];let n=!0,s=!1;for(let t=0;t<e.length;t++){const o=e[t].trim();if(0!=o.length)if(o.includes(":")){const t=o.split(":");if(2===t.length){const e=t[0].trim(),o=t[1].trim(),r=parseInt(o);isNaN(r)||o!==r.toString()?(n=!1,i.push({color:e})):(i.push({color:e,index:r}),s=!0)}else n=!1,i.push({color:o})}else n=!1,i.push({color:o})}if(n&&i.length>0)for(const t of i)this._colorsChannel[t.color.toLowerCase()]=t.index;else{s&&!n&&console.warn(`[WARNING] Binding ${this.nodeName} with id=${this.id}: Mixed format detected in 'colors-channel' attribute. Some colors have explicit indices while others don't. Falling back to sequential assignment from 0.`);for(let t=0;t<i.length;t++)this._colorsChannel[i[t].color.toLowerCase()]=t}}_parseChannelsPerElement(){const t=this.getAttribute("channels-per-element");if(t)try{this._channelsPerElement=parseInt(t)}catch(t){console.error(`[ERROR] Invalid 'channels-per-element' attribute: ${this._channelsPerElement}`)}}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){this._validateAttributes()&&(this._parseChannelsPerElement(),this._parseColorsChannel(),this._parseColorPropertyNames())}elementAttributeModified(t,e,i,n){}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){this._colorPropertyNames.includes(i)&&this.elements.has(t)&&this._colorsChannel&&this.bdcom&&this.bdcom.ws&&this.bdcom.ws.readyState===WebSocket.OPEN&&this._mtx.lock().then(e=>{try{const i=(t+1)*this._channelsPerElement-1;if(this._data.length<=i){const t=i+1-this._data.length;for(let e=0;e<t;e++)this._data.push("0")}n=n.trim().toLowerCase();const s=this._colorsChannel[n];let o=new Map;const r=t*this._channelsPerElement;for(let t=0;t<this._channelsPerElement;t++)o.set(r+t,"0");void 0!==s&&s<this._channelsPerElement&&o.set(r+s,"1");let a=!0;for(const[t,e]of o)if(this._data[t]!=e){a=!1;break}if(a)return void e();for(const[t,e]of o)this._data[t]=e;const d=this._data.join("");this.bdcom.write(this,d),e()}catch(t){e(),console.error(t)}}).catch(t=>{console.error(t)})}_parseColorPropertyNames(){const t=this.getAttribute("color-property-names");t?(this._colorPropertyNames=t.trim().split(/\s+/).filter(t=>t.length>0),0===this._colorPropertyNames.length&&(this._colorPropertyNames=["color"])):this._colorPropertyNames=["color"]}}class HTMLIoTIOBitsLockBindingElement extends HTMLElement{constructor(){super(),this._data="",this.elements=new Map,this.addEventListener("load",t=>{this._init()})}elementAttributeModified(t,e,i,n){"locked"==i&&this._updateLockState(t,e)}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;const t=this.getAttribute("location");return t?(this.elements.size>1&&console.warn(`[WARNING] Binding ${this.nodeName} with id=${this.id} has location "${t}" already in use by another binding. Each lock should have its own dedicated driver file for safety and reliability. Sharing device files between bindings can cause unpredictable behavior and security risks.`),!0):(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){this._validateAttributes()&&(this._syncInitialState(),this.bdcom&&this.bdcom.subscribeRead(this),this.buffer="")}_syncInitialState(){const t=this.elements.get(0);if(t){const e=t.hasAttribute("locked")?"1":"0";this._onData(e)}else{const t="0";this._onData(t)}}onData(t,e){if(t||!e||!e.data)return void console.error(`Error reading device file ${this.location} of binding ${this.nodeName} with id=${this.id} : `,t);const i=new Uint8Array(e.data),n=new TextDecoder("utf-8");this.buffer+=n.decode(i);let s=this.buffer.split(/\r\n|\r|\n/);this.buffer=s.pop(),s.forEach(t=>{this._onData.call(this,t)})}_onData(t){if(0==t.length||0==this._data.length)return;if((t=t[0])===this._data)return;const e=this.elements.get(0);e&&("1"===t?e.setAttribute("locked",""):e.removeAttribute("locked"))}_updateLockState(t,e){if(!this.bdcom||!this.bdcom.ws||this.bdcom.ws.readyState!==WebSocket.OPEN)return;const i=e.hasAttribute("locked")?"1":"0";i!==this._data&&(this._data=i,this.bdcom.write(this,i))}}class HTMLIoTOTextMessageBindingElement extends window.HTMLElement{constructor(){super(),this._currentMessage="",this.elements=new Map,this.addEventListener("load",t=>{this._init()})}elementAttributeModified(t,e,i,n){"message"===i&&this._updateMessage(t,e)}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){this._validateAttributes()&&this._writeMessage("")}_updateMessage(t,e){const i=e.getAttribute("message")||"";this._currentMessage!==i&&(this._currentMessage=i,this._writeMessage(i))}_writeMessage(t){if(!this.bdcom||!this.bdcom.ws||this.bdcom.ws.readyState!==WebSocket.OPEN)return;const e=t.substring(0,120);this.bdcom.write(this,e)}}class HTMLIoTIBitsItemBindingElement extends HTMLElement{constructor(){super(),this._data="",this.elements=new Map,this.addEventListener("load",t=>{this._init()}),this.buffer=""}elementAttributeModified(t,e,i,n){}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){this._validateAttributes()&&this.bdcom&&this.bdcom.subscribeRead(this)}onData(t,e){if(t||!e||!e.data)return void console.error(`Error reading device file ${this.location} of binding ${this.nodeName} with id=${this.id} : `,t);const i=new Uint8Array(e.data),n=new TextDecoder("utf-8");this.buffer+=n.decode(i);let s=this.buffer.split(/\r\n|\r|\n/);this.buffer=s.pop(),s.forEach(t=>{this._onData.call(this,t)})}_onData(t){for(let e=0;e<t.length;e++){if(!this.elements||!this.elements.has(e))continue;const i=t[e],n=this._data[e];if(n&&n==i)continue;const s=this.elements.get(e);if(1==i){const t=new Event("pickup");s.dispatchEvent(t)}else{const t=new Event("putdown");s.dispatchEvent(t)}}this._data=t}}class HTMLIoTOTextVideoBindingElement extends HTMLElement{constructor(){super(),this._currentSrc="",this._isPlaying=!1,this._currentTime=0,this._duration=20,this._loop=!1,this.elements=new Map,this.buffer="",this.addEventListener("load",()=>{this._init()})}elementAttributeModified(t,e,i,n){"src"===i?this._writeSrc(e.getAttribute("src")):"loop"===i&&this._writeLoop(e.hasAttribute("loop"))}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){if(!this._validateAttributes())return;this.bdcom&&this.bdcom.subscribeRead(this);const t=this.elements.get(0);if(!t)return;this._setupVideoElement(t);const e=t.getAttribute("src")||t.src;e&&this._writeSrc(e);const i=t.hasAttribute("loop")||t.loop;this._writeLoop(i);(t.hasAttribute("autoplay")||t.autoplay)&&e&&setTimeout(()=>{this._writeCommand("LOAD"),setTimeout(()=>{this._writeCommand("PLAY")},100)},100)}_setupVideoElement(t){const e=this;t.play=function(){return e._isPlaying=!0,e._writeCommand("PLAY"),this._paused=!1,this._ended=!1,this.dispatchEvent(new Event("play")),setTimeout(()=>{e._isPlaying&&this.dispatchEvent(new Event("playing"))},50),Promise.resolve()},t.load=function(){e._writeCommand("LOAD"),e._currentTime=0,this._currentTime=0,this._ended=!1,this.dispatchEvent(new Event("loadstart")),setTimeout(()=>{this._duration=e._duration,this.dispatchEvent(new Event("loadeddata"))},100)},t.pause=function(){e._isPlaying=!1,e._writeCommand("PAUSE"),this._paused=!0,this.dispatchEvent(new Event("pause"))},t.seek=function(t){e._writeCommand(`SET CURRENT_TIME=${t}`),e._currentTime=t,this._currentTime=t,this.dispatchEvent(new Event("timeupdate"))},Object.defineProperty(t,"currentTime",{get:()=>e._currentTime,set:function(t){const i=Math.max(0,Math.min(t,e._duration));e._currentTime!==i&&(e._currentTime=i,e._writeCommand(`SET CURRENT_TIME=${i}`),this.dispatchEvent(new Event("timeupdate")))},configurable:!0}),Object.defineProperty(t,"duration",{get:()=>e._duration,configurable:!0}),Object.defineProperty(t,"paused",{get:()=>!e._isPlaying,configurable:!0}),Object.defineProperty(t,"ended",{get:function(){return this._ended||!1},configurable:!0}),Object.defineProperty(t,"loop",{get:()=>e._loop,set:function(t){const i=Boolean(t);e._loop!==i&&(e._loop=i,e._writeLoop(i),i?this.setAttribute("loop",""):this.removeAttribute("loop"))},configurable:!0}),Object.defineProperty(t,"src",{get:function(){return this.getAttribute("src")||""},set:function(t){t?this.setAttribute("src",t):this.removeAttribute("src"),this.dispatchEvent(new Event("loadstart"))},configurable:!0})}onData(t,e){if(t||!e||!e.data)return void console.error(`[ERROR] iotext-video binding ${this.id}: Read error:`,t);const i=new Uint8Array(e.data),n=new TextDecoder("utf-8");this.buffer+=n.decode(i);let s=this.buffer.split(/\r\n|\r|\n/);this.buffer=s.pop(),s.forEach(t=>{this._onData(t)})}_onData(t){const e=t.trim(),i=this.elements.get(0);if(i)if("END"===e)this._isPlaying=!1,this._currentTime=this._duration,i._ended=!0,i._paused=!0,i._currentTime=this._duration,i.dispatchEvent(new Event("ended"));else if(e.startsWith("CURRENT_TIME=")){const t=e.substring(13),n=parseFloat(t);isNaN(n)||(this._currentTime=n,i._currentTime=n,i.dispatchEvent(new Event("timeupdate")))}}_writeCommand(t){this.bdcom&&this.bdcom.ws&&this.bdcom.ws.readyState===WebSocket.OPEN&&this.bdcom.write(this,t)}_writeSrc(t){t&&this._currentSrc!==t&&(this._currentSrc=t,this._writeCommand(`SET SRC=${t}`))}_writeLoop(t){this._loop=t,this._writeCommand("SET LOOP="+(t?"TRUE":"FALSE"))}}class HTMLIoTOTextAttributeBindingElement extends HTMLElement{constructor(){super(),this._attributeName="text",this._currentText="",this.elements=new Map,this.addEventListener("load",t=>{this._init()})}elementAttributeModified(t,e,i,n){i===this._attributeName&&this._writeText(e.getAttribute(this._attributeName))}elementAttributeNSModified(t,e,i,n,s){}elementStyleModified(t,e,i,n){}_validateAttributes(){if(!this.id)return console.error(`[ERROR] Binding ${this.nodeName} has no 'id' attribute`),!1;return!!this.getAttribute("location")||(console.error(`[ERROR] Binding ${this.nodeName} with id=${this.id} has no 'location' attribute`),!1)}_init(){if(!this._validateAttributes())return;this._attributeName=this.getAttribute("attribute-name")||"text";const t=this.elements.get(0);t&&this._writeText(t.getAttribute(this._attributeName))}_writeText(t){if(!t||this._currentText==t)return;if(!this.bdcom||!this.bdcom.ws||this.bdcom.ws.readyState!==WebSocket.OPEN)return;const e=this._attributeName+"="+t.substring(0,1024);this._currentText=t,this.bdcom.write(this,e)}}let iotBindings=new HTMLElementCollection;iotBindings.add("iot-ibits-button-binding",HTMLIoTIBitsButtonBindingElement),iotBindings.add("iot-obits-color-binding",HTMLIoTOBitsColorBindingElement),iotBindings.add("iot-iobits-lock-binding",HTMLIoTIOBitsLockBindingElement),iotBindings.add("iot-otext-message-binding",HTMLIoTOTextMessageBindingElement),iotBindings.add("iot-ibits-item-binding",HTMLIoTIBitsItemBindingElement),iotBindings.add("iot-otext-video-binding",HTMLIoTOTextVideoBindingElement),iotBindings.add("iot-otext-attribute-binding",HTMLIoTOTextAttributeBindingElement);